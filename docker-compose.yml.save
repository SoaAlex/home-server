version: '2.4'
services:
  ## TOOLS
  # Nginx proxy manager to handle multiple services in 1 machine
  nginx-proxy-manager:
    image: 'jc21/nginx-proxy-manager:latest'
    container_name: nginx_proxy_manager
    restart: unless-stopped
    ports:
      - '80:80'
      - '81:81'
      - '443:443'
    volumes:
      - ./data:/data
      - ./letsencrypt:/etc/letsencrypt
   sysctls:
      - "net.ipv6.conf.all.disable_ipv6=0"

  # ipv6nat to handle IPv6 networking with docker (auto IPv6 port mapping)
  #ipv6nat:
  #  container_name: ipv6nat
  #  restart: always
  #  image: robbertkl/ipv6nat
  #  privileged: true
  #  network_mode: host
  #  volumes:
  #    - /var/run/docker.sock:/var/run/docker.sock:ro
  #    - /lib/modules:/lib/modules:ro
  
  ## SERVICES
  # PiHole: AdBlocking DNS service
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    ports:
      - '53:53/tcp'
      - '53:53/udp'
      - "67:67/udp"
      - '82:80/tcp'
    volumes:
      - './etc-pihole:/etc/pihole'
      - './etc-dnsmasq.d:/etc/dnsmasq.d'
    cap_add:
      - NET_ADMIN
    environment:
      WEBPASSWORD: ${PIHOLE_PASSWORD}
      ServerIP: 192.168.1.54
      ServerIPv6: "2a01:cb0c:d8e:6d00:7d22:232a:7c2a:74bf"
      PROXY_LOCATION: pihole
      VIRTUAL_HOST: pihole-soaalex.duckdns.org
      VIRTUAL_PORT: 80
      PIHOLE_DNS_: "1.1.1.1;1.0.0.1"
      DNSSEC: "true"
      IPv6: "true"
    restart: always
    sysctls:
      - "net.ipv6.conf.all.disable_ipv6=0"

  # Bitwarden: password manager
  bitwarden:
    image: vaultwarden/server:latest
    container_name: bitwarden
    ports:
      - '83:80'
      - '3012:3012'
    volumes:
      - /vw-data/:/data
sysctls:
      - "net.ipv6.conf.all.disable_ipv6=0"

  # Wireguard: efficient VPN
  wireguard:
    image: lscr.io/linuxserver/wireguard:latest
    container_name: wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Paris
      - SERVERURL=vpn-soaalex.duckdns.org
      - SERVERPORT=51820
      - PEERS="iphonealex,pcalex,iphonecloe"
      - PEERDNS=172.18.0.6
      - LOG_CONFS=true
    volumes:
      - /path/to/appdata/config:/config
      - /lib/modules:/lib/modules
    ports:
      - 51820:51820/udp
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
    restart: always

  # NextCloud: Home Cloud - NAS
  nextcloud:
    image: linuxserver/nextcloud
    container_name: nextcloud
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Paris
    volumes:
      - ./data/nextcloud/config:/config
      - ./data/nextcloud/data:/data
    ports:
      - 84:443
    depends_on:
      - mariadb
    restart: unless-stopped

  mariadb:
    image: linuxserver/mariadb
    container_name: mariadb
    environment:
      - PUID=1000
      - PGID=1000
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - TZ=Europe/Paris
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - ./data/nextcloud/mariadb:/config
    restart: unless-stopped 

# Network settings
#networks:
#  app_net:
#    ipam:
#      driver: default
#      config:
#        - subnet: "2a01:cb0c:d8e:6d00::/56"
